









<!doctype html>
<html lang="zh-cn,en,default">
  <head>
    <meta charset="UTF-8">
    <title>2021年终总结：书、游戏和Kache的进展</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    
      
      
        <link rel="stylesheet" href="/css/cmd.css" media="print" onload="this.media='all'; this.onload=null;">
        <noscript><link rel="stylesheet" href="/css/cmd.css"></noscript>
      
        <link rel="stylesheet" href="/css/materialdesignicons.min.css" media="print" onload="this.media='all'; this.onload=null;">
        <noscript><link rel="stylesheet" href="/css/materialdesignicons.min.css"></noscript>
      
        <link rel="stylesheet" href="/css/entry.css" media="print" onload="this.media='all'; this.onload=null;">
        <noscript><link rel="stylesheet" href="/css/entry.css"></noscript>
      
        <link rel="stylesheet" href="/css/xcode.css" media="print" onload="this.media='all'; this.onload=null;">
        <noscript><link rel="stylesheet" href="/css/xcode.css"></noscript>
      
    
    <link rel="stylesheet" href="/materialize/css/materialize.css"/>
    
    <meta name="generator" content="Hexo 6.1.0"></head>

    <body>
      <ul id="nav-mobile" class="sidenav">
        
          <li>
            <a href="/">Home</a>
          </li>
        
          <li>
            <a href="/archives">Archives</a>
          </li>
        
      </ul>
      <nav class="light-blue lighten-1" role="navigation">
        <a href="#" data-target="nav-mobile" class="sidenav-trigger">
          <div class="mdi mdi-menu"></div>
        </a>
        <div class="nav-wrapper">
          <ul class="right hide-on-med-and-down">
            
              <li>
                <a href="/">Home</a>
              </li>
            
              <li>
                <a href="/archives">Archives</a>
              </li>
            
          </ul>
        </div>
      </nav>

      <main id="content" class="container xscontainer">
        
  <article id="post">
    <div class="card">
    <div class="card-content">
      <span class="card-title">2021年终总结：书、游戏和Kache的进展</span>
      <div class="row">
        <div class="col" style="padding-left:0;"><span class="mdi mdi-account">Rubicon</span></div>
        <div class="col"><span class="mdi mdi-clock">2022/1/18</span></div>
      </div>
      
  <div>
  
    <a href="/tags/%E5%B9%B4%E7%BB%88%E6%80%BB%E7%BB%93/"><div class="chip">
      年终总结
    </div></a>
  
  </div>

      
      <div class="entry">
      <p>又过了一年。受到Mastodon时间线上的博主们启发，我想写一篇博文总结一下一年来做的事情。但是我发现我不知道该怎么组织起这样一篇博文。想了想，决定以今年看过的书、玩过的游戏和一些项目为脉络，聊聊今年的感想。减少尴尬，先以小作文经典开头问声好。</p>
<blockquote>
<p>人的脆弱和坚强都超乎自己的想象。有时，我们可能脆弱得一句话就泪流满面；有时，也发现自己咬着牙走了很长的路。 —— 莫泊桑《一生》</p>
</blockquote>
<span id="more"></span>

<h2 id="书"><a href="#书" class="headerlink" title="书"></a>书</h2><p>2021年其实可以说是我精神状态最差的一年。问题大概来源于无根浮萍的那种漂浮感——往大了说，政治、经济形势的恶化；往小了说，未来发展和学业……但这只是环境上的变化。而个人因素大概就是因为我就是那么个人吧。这一年，我读书的重点大概在于理解我的恐惧和我的社会。从端传媒两本关于香港的会员赠书、《香港第一课》到哈耶克的《个人主义与经济秩序》、《理性之谜》、两本关于美国政治体制的科普书，它们从不同角度展示社会图景。而《最好的告别》是我直面我所恐惧之一的机会：直面这从未有人回头过的旅途。</p>
<p>2021年我还看了不少书，但能让我挤出一些感想的大概也就这些。</p>
<h3 id="《黑暗时代，在香港点灯的人》-amp-《香港喺度》"><a href="#《黑暗时代，在香港点灯的人》-amp-《香港喺度》" class="headerlink" title="《黑暗时代，在香港点灯的人》&amp;《香港喺度》"></a>《黑暗时代，在香港点灯的人》&amp;《香港喺度》</h3><p>这两本是端传媒的会员赠书。端传媒先后免费赠过几本关于香港的书，都让我印象深刻。它们为我脑海中平面的香港多画了几笔阴影，有了更多的景深和面向。最让我印象深刻的是《香港喺度》中有一篇文章讲述逃离城市到离岛上的故事，我觉得有些居于宁静、繁华不远的暧昧感觉。</p>
<h3 id="《香港第一课》梁启智"><a href="#《香港第一课》梁启智" class="headerlink" title="《香港第一课》梁启智"></a>《香港第一课》梁启智</h3><p>这一本也是关于香港的书，而且是一门关于“香港问题”的书。这本书用更客观的视角（相比中国官媒和我们自己）询问了一些“香港问题”并给出一种回答。它并非香港问题的唯一答案，但是确实是了解香港问题和民主制度不能避开的小册子。</p>
<h3 id="《打开一颗心》斯蒂芬·韦斯塔比"><a href="#《打开一颗心》斯蒂芬·韦斯塔比" class="headerlink" title="《打开一颗心》斯蒂芬·韦斯塔比"></a>《打开一颗心》斯蒂芬·韦斯塔比</h3><p>奇幻的现实旅程。韦斯塔比是一位英国著名的“心脏外科”医生，这本书讲述的就是他从医经历中的一些片段：“打开一颗心”。书中提到了很多奇妙的治疗方案，我印象最深刻的就是人工心脏：使用人工心脏的人没有脉搏但还是可以正常生活，“让我感到了科技的进步”。</p>
<h3 id="《个人主义与经济秩序》Friedrich-August-von-Hayek"><a href="#《个人主义与经济秩序》Friedrich-August-von-Hayek" class="headerlink" title="《个人主义与经济秩序》Friedrich August von Hayek"></a>《个人主义与经济秩序》Friedrich August von Hayek</h3><p>哈耶克的观点可谓超越时代。有些人可能会将哈耶克的观点简单归类为“新自由主义”，然而我觉得这并不准确。我认为，哈耶克既不坚持古典自由主义，也并不提倡所谓“新自由主义”。在这本书里，我看到了他对“个人主义”研究导向的追求。</p>
<h3 id="《理性之谜》雨果·梅西耶和丹·斯珀伯"><a href="#《理性之谜》雨果·梅西耶和丹·斯珀伯" class="headerlink" title="《理性之谜》雨果·梅西耶和丹·斯珀伯"></a>《理性之谜》雨果·梅西耶和丹·斯珀伯</h3><p>这本书以心理学的角度综述了一个我们尚未完全理解的事实：个体理性工具的不可靠。很有趣的是：哈耶克很早就在上面的《个人主义与经济秩序》中提出了类似的问题，这就是为什么我说哈耶克的观点可以说超越时代。</p>
<h3 id="《美国最高法院》（牛津通识读本）琳达•格林豪斯"><a href="#《美国最高法院》（牛津通识读本）琳达•格林豪斯" class="headerlink" title="《美国最高法院》（牛津通识读本）琳达•格林豪斯"></a>《美国最高法院》（牛津通识读本）琳达•格林豪斯</h3><p>一本一百多页的小册子，包含了美国最高法院的历史、运转甚至宪法的工作方式。给我留下了一些关于法律的问题和思考：法律究竟如何运作？为何运作？怎样运作更好？</p>
<h3 id="《言论的边界：美国宪法第一修正案简史》安东尼·刘易斯"><a href="#《言论的边界：美国宪法第一修正案简史》安东尼·刘易斯" class="headerlink" title="《言论的边界：美国宪法第一修正案简史》安东尼·刘易斯"></a>《言论的边界：美国宪法第一修正案简史》安东尼·刘易斯</h3><p>简介：“本书作者以理性客观的视角和深入浅出的文笔，向读者介绍了美国宪法第一修正案产生的历史背景，及其对美国社会的过去、现在和可预计的将来所产生的深刻影响。”这简介远远无法包含这本小书的内容。“言论的边界”在实践中如此复杂，我们尚未有万能的解决之道。中国当下的情况，在美国历史上早有影子。</p>
<h3 id="《破云》《破云2：吞海》淮上"><a href="#《破云》《破云2：吞海》淮上" class="headerlink" title="《破云》《破云2：吞海》淮上"></a>《破云》《破云2：吞海》淮上</h3><p>《破云》系列的故事背景是很少见的缉毒，单是题材就令人感到很新鲜。《破云》的反派描写实在是出彩，那句“六亿美金……你看，尘世的快乐就是如此值钱”实在是让我记忆犹新。《破云2：吞海》和《破云》的节奏、套路相似，但不是简单的换皮。<br>把这两本书写在这里是想感慨一下这个作者的作品好几部都有一些想探索的议题，比如更早的《银河帝国之刃》甚至涉及到了民主和独裁的话题。《破云2：吞海》涉及到了自由的话题，不过我觉得作者对于自由的理解写得稍微有点浅薄，单独放在最后一章的时候其实力度有点不够。</p>
<h3 id="《最好的告别：关于衰老和死亡，你必须知道的常识》Atul-Gawande和彭小华"><a href="#《最好的告别：关于衰老和死亡，你必须知道的常识》Atul-Gawande和彭小华" class="headerlink" title="《最好的告别：关于衰老和死亡，你必须知道的常识》Atul Gawande和彭小华"></a>《最好的告别：关于衰老和死亡，你必须知道的常识》Atul Gawande和彭小华</h3><p>“如果说人生是一场盛大的史诗，那么这一定来自于既定的出生与既定的死亡。”面对与世界的告别，是所有人不得不学习却又终究觉得差一些的事情。作为仍有时间的人，我们所能做的也就是“偶尔治愈”“常常帮助”“总是安慰”，像这本书的主题一样，停下来思考：怎样让这种告别更有尊严一些？</p>
<p>若不是人们害怕那遥远的风之旅国，害怕未知的远方……我们也只是车站上的过客。伊甸园外，唯有故事隽永流芳。</p>
<h2 id="文章和演讲"><a href="#文章和演讲" class="headerlink" title="文章和演讲"></a>文章和演讲</h2><p>今年让我印象深刻主要有演讲《User level threads.. with threads》、文章《Go Does Not Need a Java Style GC》《Locking in Webkit》。前两篇是今年我性能观念大转变的来源，后面一篇是因为这个锁的实现真的很有意思。</p>
<h3 id="User-level-threads-with-threads-Paul-Turner"><a href="#User-level-threads-with-threads-Paul-Turner" class="headerlink" title="User level threads.. with threads, Paul Turner"></a>User level threads.. with threads, Paul Turner</h3><p>系统线程跟高性能I/O并没有冲突。这个演讲的主要内容就是：上下文切换时的开销主要来自计算下一个要排期的线程，而不是陷入ring0的开销，他们做到低切换开销的方法。在前面介绍了几种并行编程的常用模型。</p>
<p>P.S. 得益于Linux Kernel默认打开的Overcommit，创建线程的内存成本并不高。</p>
<p><a target="_blank" rel="noopener" href="https://web.archive.org/web/20210212205254/http://pdxplumbers.osuosl.org/2013/ocw//system/presentations/1653/original/LPC%20-%20User%20Threading.pdf">互联网博物馆的Slides存档</a></p>
<h3 id="Go-Does-Not-Need-a-Java-Style-GC-Erik-Engheim"><a href="#Go-Does-Not-Need-a-Java-Style-GC-Erik-Engheim" class="headerlink" title="Go Does Not Need a Java Style GC, Erik Engheim"></a>Go Does Not Need a Java Style GC, Erik Engheim</h3><p>Go同时拥有超高的性能和……由GC驱动的自动内存管理。但是在Java看来，这完全不可能。但现实就是如此奇妙，Go通过支持“值”加上Escape Analysis来自动确定值是否需要放在堆上，大幅降低GC的压力，使得Go不需要一个像Java那种运行得很快的GC，反而可以使用传统的标记-清除算法，这种传统算法的优势是没有“Stop The World!”修改指针的过程，可以并行运行。<br>Java所需的“现代”“高速”GC反而会成为并行运行的性能瓶颈（在Android上一样适用！），为了保证locality和降低开销，Oracle JVM使用了分代标记-清除-合并算法。其它JVM实现也有些会选择类似的方法，因为这个算法可以说是GC领域里最“好”的一个。但是，这个算法的致命缺陷在于：在升代或是合并时需要移动值的位置，在移动值的过程中需要修改指针。而唯一能又快又安全地修改指针的前提条件就是让程序停止，Stop The World！</p>
<p><a target="_blank" rel="noopener" href="https://erik-engheim.medium.com/go-does-not-need-a-java-style-gc-ac99b8d26c60">Erik Engheim: Go Does Not Need a Java Style GC</a></p>
<h3 id="Locking-in-Webkit-Filip-Pizlo"><a href="#Locking-in-Webkit-Filip-Pizlo" class="headerlink" title="Locking in Webkit, Filip Pizlo"></a>Locking in Webkit, Filip Pizlo</h3><p>这篇文章介绍了Webkit使用的用户空间锁，相对于庞大的OS Mutex（至少64 bytes）来说，Webkit使用的这种锁大小不到1 byte。它通过一个在进程中共享的并发HashMap实现等待队列，叫做Parkinglot（停车场）。</p>
<p>Webkit将这个锁实现成自适应情况的：刚开始时表现得像SpinLock，过一段时间后用system call将自己放到系统的schedule队列末尾。开发者不用考虑到底该用SpinLock还是OS Mutex，最终性能非常漂亮：WebKit的JavaScript跑分增加了5%。</p>
<p>我写过一个在Zig里的简单实现： <a target="_blank" rel="noopener" href="https://gist.github.com/thislight/e9c7335932a7139910c441d2770c33c5">https://gist.github.com/thislight/e9c7335932a7139910c441d2770c33c5</a></p>
<p><a target="_blank" rel="noopener" href="https://webkit.org/blog/6161/locking-in-webkit/">Webkit Blog: Locking in Webkit</a></p>
<h2 id="游戏"><a href="#游戏" class="headerlink" title="游戏"></a>游戏</h2><p>其实今年我玩了十多款游戏，但是让我有些想法想分享的游戏也就寥寥：将网状叙事、非线性流程、开放世界拉到极致的《辐射：新维加斯》、《地铁》游戏新作《离乡》。</p>
<h3 id="《辐射：新维加斯》"><a href="#《辐射：新维加斯》" class="headerlink" title="《辐射：新维加斯》"></a>《辐射：新维加斯》</h3><iframe src="https://store.steampowered.com/widget/22380/" frameborder="0" width="100%" height="190"></iframe>

<p>迄今为止无人超越的，最有野心也最令人感到遗憾的RPG（Role-Playing Game）作品。很多人都说GTA系列（3、4、5）或《塞尔达：旷野之息》是开放世界神作，但对我来说《辐射：新维加斯》才是真正的“开放世界”：在大多数开放世界作品中你只是体验到开放的表象，但在《辐射：新维加斯》中，<strong>你能改变世界</strong>。《辐射：新维加斯》的故事构建和网状叙事至今无人超越，这款游戏真正地踏入了那片没有敌手的黄沙。</p>
<iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/gzF7aHxk4Y4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

<p>跟优秀的游戏设计相对的，就是非常恐怖的bug数量，这款游戏的bug修到结束支持都没修完。我在玩之前按照<a target="_blank" rel="noopener" href="https://vivanewvegas.github.io/">Viva New Vegas</a>的列表打了一遍MOD，这个modlist里面已经包含了很多由玩家社区提供的修复和改进，至少bug基本都修好了。</p>
<p>愿那狂野的灵魂，在宁静的黄沙中安息。</p>
<h3 id="《地铁：离乡》"><a href="#《地铁：离乡》" class="headerlink" title="《地铁：离乡》"></a>《地铁：离乡》</h3><iframe src="https://store.steampowered.com/widget/412020/" frameborder="0" width="100%" height="190"></iframe>

<p>《地铁》系列与《辐射》一样，使用后末世启示录作为背景，但少几分黑色幽默，多几分认真。作为《地铁》系列游戏的第三部，《地铁：离乡》在系统和玩法上已经非常成熟，唯一改变的是从过去的封闭场景线性流程变为沙盒式世界半开放流程。我个人很喜欢这种改变，特别是这种改变也意味剧情背景的改变——从地铁隧道里走出来，走出莫斯科，火车行驶于俄罗斯大地，寻找宜居之地。大概《离乡（Exodus）》的副标题就是来自于类似的犹大神话。</p>
<h2 id="Kache和Rope的进展"><a href="#Kache和Rope的进展" class="headerlink" title="Kache和Rope的进展"></a>Kache和Rope的进展</h2><p>过去一年我重新设计了4次Kache，终于在去年下半年正式开始实现。其网络层Rope的设计也曾改过几次，最终放弃使用ZeroMQ/libnng和Zig。前者是因为缺少对加密和UDP的支持，虽然libnng支持自定义Transport，但是我们本来大多数时候都要绕过它们定义的协议，使用专门点对点的socket来实现我们自己的链路管理。我们要取的只是它们基于消息的传输协议和跨平台的网络I/O，自定义transport显然完全丢弃了这两点。后者是因为作为一门语言，它每个版本间的改动仍然太多、太大，语言复杂使得编译器bug很多、修得慢，作为写一个要用的东西的语言不合适。最后我为Rope选择了Rust，正好Cloudflare正在维护一个Wireguard实现叫boringtun。</p>
<p>Rope在Wireguard之上运行Rope Protocol而不是Internet Protocol，RP是一个基于消息的协议，并且可以带有控制消息。相对于直接使用Internet Protocol再在它上弄一个额外的协议，我更倾向于使用一个集成的协议。</p>
<h2 id="新项目：Mooncake"><a href="#新项目：Mooncake" class="headerlink" title="新项目：Mooncake"></a>新项目：Mooncake</h2><p><img src="/2022/01/18/yearly-report-2021/mooncake_logo.png" alt="Mooncake Logo"></p>
<p>Go通过值类型和Escape Analysis显著降低了标记-清除系GC算法对高并发I/O的影响。Mooncake最初的主旨就是为Lisp引入值类型和Escape Analysis，降低GC对I/O的影响。个人认为CLOS这种在Lisp的括号里面实现起来太憋屈，所以我觉得Mooncake的类型系统类似Haskell和Rust会更好。</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(<span class="name">in-package</span> <span class="symbol">:my-hello-server</span>)</span><br><span class="line">(@import <span class="symbol">:std/http</span> h)</span><br><span class="line">(<span class="name">dconst</span> math (@import <span class="symbol">:std/math</span>))</span><br><span class="line"></span><br><span class="line">(<span class="name">dfn</span> (<span class="name">handler</span> (<span class="name">*</span> h:<span class="symbol">:Request</span>) h:<span class="symbol">:Response</span>) (<span class="name">_request</span>)</span><br><span class="line">    (<span class="name">if</span> (<span class="name">&gt;</span> (<span class="name">math</span>:<span class="symbol">:random</span>) <span class="number">0.5</span>)</span><br><span class="line">        (<span class="name">h</span>:<span class="symbol">:respond</span> <span class="string">&quot;Hello, World&quot;</span>) <span class="comment">;; Actually call ((std/http::ResponseSource String)::respond std/core::String std/http::Response)</span></span><br><span class="line">        (<span class="name">h</span>:<span class="symbol">:respond</span> (<span class="name">h</span>:<span class="symbol">:error</span> <span class="number">400</span> Bad Request<span class="string">&quot;))))</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">(http::quick-serve 8080 handler)</span></span><br><span class="line"><span class="string">;; (http::quick-serve 8080 (\ (_request) (h::respond &quot;</span>Hello, Word<span class="string">&quot;)))</span></span><br></pre></td></tr></table></figure>

<p>当然，这还只是画饼而已……现在还在写完括号解析器正在写LLVM binding的状态。</p>

      </div>
    </div>
    </div>
  </article>

  <div id="paginator">
    
  </div>

      </main>

        <footer class="page-footer light-blue darken-4">
          <div class="container">
            <div class="row">
              
                <div class="col s12 m4">
                  <h5 class="white-text">About Rubicon's Rubicon</h5>
                  <p>这里是Rubicon's Rubicon。我在无界之点的偏安之地。</p>
                </div>
              
              
                <div class="col s6 m4">
                  <h5 class="white-text">
                    Links
                  </h5>
                  <ul>
                    
                      <li>
                        <a class="grey-text text-lighten-3" target="_blank" rel="noopener" href="https://github.com/thislight">GitHub</a>
                      </li>
                    
                      <li>
                        <a class="grey-text text-lighten-3" target="_blank" rel="noopener" href="https://gitlab.com/thislight">GitLab</a>
                      </li>
                    
                      <li>
                        <a class="grey-text text-lighten-3" href="/atom.xml">Feed (Atom)</a>
                      </li>
                    
                      <li>
                        <a class="grey-text text-lighten-3" href="/rss.xml">Feed (RSS)</a>
                      </li>
                    
                    
                      <li>
                        <a class="grey-text text-lighten-3" rel="me noopener" target="_blank" href="https://mastodon.social/@thislight">My Mastodon</a>
                      </li>
                    
                  </ul>
                </div>
              
              
                <div class="col s6 m4">
                  <p>This blog uses Classical Material Design theme.</p>
                </div>
              
            </div>
          </div>
          <div class="footer-copyright">
            <div class="container truncate">
              © Copyright 2020-2022
              Rubicon.
              
            </div>
          </div>
        </footer>
        
          
          
            <script src="/js/cmd.js"></script>
          
            <script src="/materialize/js/materialize.js"></script>
          
        
        
      <!-- hexo injector body_end start --><!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "05f36e0cb3b74781a5755bd4224e252a"}'></script><!-- End Cloudflare Web Analytics --><!-- hexo injector body_end end --></body>
    </html>
