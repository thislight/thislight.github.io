import{b as p,v as A}from"./getDeviceId.e8f3946a.js";import{W as L}from"./index.13b310ab.js";var S={exports:{}};(function(r,e){(function(n,s){r.exports=s(),r.exports.default=r.exports})(L,function(){var n=function(){this.listeners={},this.registerListener=function(t,i,o){var a=t.constructor.name;o=this.validateNumber(o||"any"),a!=="Array"&&(t=[t]),t.forEach(function(d){if(d.constructor.name!=="String")throw new Error("Only `String` and array of `String` are accepted for the event names!");s.listeners[d]=s.listeners[d]||[],s.listeners[d].push({callback:i,number:o})})},this.validateNumber=function(t){var i=t.constructor.name;if(i==="Number")return t;if(i==="String"&&t.toLowerCase()==="any")return"any";throw new Error("Only `Number` and `any` are accepted in the number of possible executions!")},this.toBeRemoved=function(t){var i=t.number;return t.execution=t.execution||0,t.execution++,!(i==="any"||t.execution<i)};var s=this;return{on:function(t,i){s.registerListener.bind(s)(t,i,"any")},once:function(t,i){s.registerListener.bind(s)(t,i,1)},exactly:function(t,i,o){s.registerListener.bind(s)(i,o,t)},die:function(t){delete s.listeners[t]},off:function(t){this.die(t)},detach:function(t,i){if(i===void 0)return s.listeners[t]=[],!0;for(var o in s.listeners[t])if(s.listeners[t].hasOwnProperty(o)&&s.listeners[t][o].callback===i)return s.listeners[t].splice(o,1),this.detach(t,i);return!0},detachAll:function(){for(var t in s.listeners)s.listeners.hasOwnProperty(t)&&this.detach(t)},emit:function(t,i){var o=[];for(var a in s.listeners)if(s.listeners.hasOwnProperty(a)&&(a===t&&Array.prototype.push.apply(o,s.listeners[a]),a.indexOf("*")>=0)){var d=a.replace(/\*\*/,"([^.]+.?)+");d=d.replace(/\*/g,"[^.]+");var l=t.match(d);l&&t===l[0]&&Array.prototype.push.apply(o,s.listeners[a])}var m=arguments;i=i||this,o.forEach(function(u,R){var g=u.callback;u.number,i&&(g=g.bind(i));var y=[];Object.keys(m).map(function(D){D>1&&y.push(m[D])}),s.toBeRemoved(u)&&s.listeners[t].splice(R,1),g.apply(null,y)})}}};return n})})(S);var f=S.exports;const c=class{constructor(r){this.buffer=r}static zero(r){const e=r>c.SHORT_MAX_LENGTH,n=(e?c.LONG_HEADER_SIZE:c.SHORT_HEADER_SIZE)+r,s=new Uint8Array(n),t=new c(s);return t.setFlag("long",e),t.length=r,t}getFlags(){const r=this.buffer.at(0);return{more:(r&c.FLAG_MORE)>0,long:(r&c.FLAG_LONG)>0}}setFlag(r,e){const n=this.buffer.at(0);return r==="more"?this.buffer[0]=e?n|c.FLAG_MORE:n&~c.FLAG_MORE:r==="long"&&(this.buffer[0]=e?n|c.FLAG_LONG:n&~c.FLAG_LONG),this.getFlags()}validateLength(){if(this.byteLength>1){const r=this.getFlags().long?c.LONG_HEADER_SIZE:c.SHORT_HEADER_SIZE;if(this.byteLength>=r&&this.byteLength>=r+this.length)return this.length}return null}get length(){return this.getFlags().long?new DataView(this.buffer.buffer,1+this.buffer.byteOffset,4).getUint32(0):new DataView(this.buffer.buffer,1+this.buffer.byteOffset,2).getUint16(0)}set length(r){this.getFlags().long?new DataView(this.buffer.buffer,1+this.buffer.byteOffset,4).setInt32(0,r):new DataView(this.buffer.buffer,1+this.buffer.byteOffset,2).setInt16(0,r)}get byteLength(){return this.buffer.length}data(){return this.getFlags().long?this.buffer.subarray(c.LONG_HEADER_SIZE,c.LONG_HEADER_SIZE+this.length):this.buffer.subarray(c.SHORT_HEADER_SIZE,c.SHORT_HEADER_SIZE+this.length)}dataView(r){const e=typeof r!="undefined"?Math.min(r,this.length):this.length,n=this.headerLength;return new DataView(this.buffer.buffer,n+this.buffer.byteOffset,e)}static fromArray(r,e){const n=c.zero(r.length);return n.data().set(r),n.setFlag("more",e||!1),n}static fromString(r,e){const s=new TextEncoder().encode(r);return this.fromArray(s,e)}toString(){return new TextDecoder("utf-8").decode(this.data())}static fromUInt(r,e){const n=new Uint8Array(4);return new DataView(n.buffer).setUint32(0,r),c.fromArray(n,e)}toUInt(){return this.dataView().getUint32(0)}isUInt(){return this.length===4}static fromBigUInt(r,e){const n=new Uint8Array(8);return new DataView(n.buffer).setBigUint64(0,r),c.fromArray(n,e)}toBigUInt(){return this.dataView().getBigUint64(0)}isBigUInt(){return this.length===8}static pack(...r){const e=r.map(t=>t.byteLength).reduce((t,i)=>t+i,0),n=new Uint8Array(e);let s=0;for(const t of r)n.set(t.buffer,s),s+=t.byteLength;return n}static readHeader(r){if(r.length===0)return null;const e=r[0],n=(e&this.FLAG_MORE)>0,s=(e&this.FLAG_LONG)>0,t=s?this.LONG_HEADER_SIZE:this.SHORT_HEADER_SIZE;if(r.length<t)return null;const i=t-1,o=new Uint8Array(i);o.set(r.subarray(1,t),0);const a=new DataView(o.buffer,0,i),d={more:n,long:s},l=s?a.getUint32(0):a.getUint16(0);return[d,l]}static unpack(r){let e=r;const n=[];for(;e.length>0;){const s=this.readHeader(e);if(s){const[t,i]=s,o=t.long?this.LONG_HEADER_SIZE:this.SHORT_HEADER_SIZE;if(e.length>=i+o){if(n.push(new c(e.subarray(0,o+i))),e=e.subarray(o+i),!t.more)break}else return[n,e,i+o-e.length]}else e=new Uint8Array(0)}return[n,e,0]}get headerLength(){return this.getFlags().long?c.LONG_HEADER_SIZE:c.SHORT_HEADER_SIZE}get paddingLength(){return this.byteLength-this.headerLength-this.length}clone(r){const e=new Uint8Array(this.headerLength+this.length+(r||0));return e.set(this.buffer.slice(0,this.headerLength+this.length)),new c(e)}};let h=c;h.FLAG_MORE=1;h.FLAG_LONG=1<<1;h.SHORT_MAX_LENGTH=2^16-(1+2);h.LONG_MAX_LENGTH=2^32-(1+4);h.SHORT_HEADER_SIZE=1+2;h.LONG_HEADER_SIZE=1+4;class T{constructor(e){this.bus=new f,this.rtcDataChan=e;const n=async s=>this.onRemoteData(s);this.rtcDataChan.addEventListener("open",()=>{this.bus.emit("open",this),this.rtcDataChan.addEventListener("message",n)}),this.rtcDataChan.addEventListener("close",()=>{this.rtcDataChan.removeEventListener("message",n),this.bus.emit("close",this)})}async send(e){const n=[h.fromString(e.dstUserDeviceId,!0),h.fromString(e.roomId,!0),h.fromString(e.srcUserDeviceId,!0),...e.message];this.rtcDataChan.send(h.pack(...n))}async onRemoteData(e){const n=e.data,[s]=h.unpack(new Uint8Array(await n.arrayBuffer())),[t,i,o,...a]=s,d={dstUserDeviceId:t.toString(),roomId:i.toString(),srcUserDeviceId:o.toString(),message:a};this.bus.emit("data",this,d)}close(){this.rtcDataChan.close()}}var U=(r,e=!1,n="Timeout")=>new Promise((s,t)=>setTimeout(e?()=>t(n):s,r));const b=1,E=2,v=3,_=4,P=255,k="magicmesh",B=64,H={iceServers:[{urls:"stun:stun.stunprotocol.org"}]};var M=(r=>(r.connecting="connecting",r.connected="connected",r.disconnected="disconnected",r.closed="closed",r.failed="failed",r.unknown="unknown",r))(M||{});class w{constructor(e,n){this.userDeviceId=e,this.connection=new RTCPeerConnection(H),this.clk=n,this.datachannel=new T(this.connection.createDataChannel(k,{protocol:"magicmesh-rtc0",id:B,negotiated:!0})),this.connectionState="unknown",this.bus=new f,this.makingOffer=!1,this.setupConnectionState(),this.connection.addEventListener("negotiationneeded",()=>this.bus.emit("negotiationneeded",void 0,this)),this.connection.addEventListener("icecandidate",s=>this.bus.emit("icecandidate",void 0,this,s)),this.connection.addEventListener("iceconnectionstatechange",()=>{this.connection.iceConnectionState==="failed"&&this.connection.restartIce()})}setupConnectionState(){typeof this.connection.connectionState!="undefined"?this.connection.addEventListener("connectionstatechange",()=>{switch(this.connection.connectionState){case"new":case"connecting":this.connectionState="connecting";break;case"closed":this.connectionState="closed";break;case"connected":this.connectionState="connected";break;case"disconnected":this.connectionState="disconnected";break;case"failed":this.connectionState="failed";break;default:this.connectionState="unknown";break}this.bus.emit("connectionstatechange",this,this.connectionState)}):this.connection.addEventListener("iceconnectionstatechange",()=>{const e=this.connection.iceConnectionState;e==="new"||e==="checking"||e==="completed"?this.connectionState="connecting":e==="connected"?this.connectionState="connected":e==="disconnected"?this.connectionState="disconnected":e==="closed"?this.connectionState="closed":e==="failed"?this.connectionState="failed":this.connectionState="unknown",this.bus.emit("connectionstatechange",this,this.connectionState)})}isConnectionAvaliable(){return this.connectionState==="connected"}async send(e,n,s){await this.datachannel.send({roomId:e,srcUserDeviceId:n,dstUserDeviceId:this.userDeviceId,message:s})}disconnect(){this.datachannel.close(),this.connection.close()}}class V{constructor(e,n,s){this.peers=[],this.alterChan=n,this.clk=BigInt(0),this.userDeviceId=e,this.bus=new f,this.roomId=s,this.onMessageCallback=t=>{(t.dstUserDeviceId===this.userDeviceId||t.dstUserDeviceId===p)&&(t.message[0].isUInt()&&t.message[0].toUInt()<=P&&t.message[1].isBigUInt()?this.handleProtocolMessage(t):this.bus.emit("data",this,t))},this.onNegotiate=t=>{t.makingOffer=!0,t.connection.setLocalDescription().then(()=>{const i=t.connection.localDescription;if(i){const{sdp:o,type:a}=i;return this.provideRTCOffer(t.userDeviceId,{sdp:o,type:a})}}).finally(()=>t.makingOffer=!1)},this.onIceCandidate=(t,i)=>{i.candidate&&this.sendRTCIceCandidate(t.userDeviceId,i.candidate)},n.bus.on("data",this.onMessageCallback)}async broadcast(e,n){const s=[];for(const t of this.peers)t.isConnectionAvaliable()&&s.push(t.send(this.roomId,this.userDeviceId,e));!n&&s.length===0?await this.sendToAlternativeChannel(p,e):await Promise.all(s)}findPeerById(e){for(const n of this.peers)if(n.userDeviceId===e)return n;return null}loopbackSend(e,n){this.bus.emit("data",this,{srcUserDeviceId:this.userDeviceId,dstUserDeviceId:e,message:n,roomId:this.roomId})}async send(e,n){if(e===this.userDeviceId){this.loopbackSend(e,n);return}const s=this.findPeerById(e);s&&(s.isConnectionAvaliable()?await s.send(this.roomId,this.userDeviceId,n):await this.sendToAlternativeChannel(e,n))}async broadcastPeerList(e,n){const s=e||[this.userDeviceId,...this.peers.map(i=>i.userDeviceId)],t=this.buildProtocolMessage(n?v:b,s);await this.broadcast(t)}async sendToAlternativeChannel(e,n){await this.alterChan.send({srcUserDeviceId:this.userDeviceId,dstUserDeviceId:e,roomId:this.roomId,message:n})}addPeer(e){e.datachannel.bus.on("data",this.onMessageCallback),e.bus.on("negotiationneeded",this.onNegotiate),e.bus.on("icecandidate",this.onIceCandidate),this.peers.push(e),this.bus.emit("addpeer",this,e)}removePeer(e){const n=this.peers.indexOf(e);this.peers.splice(n,1),e.datachannel.bus.detach("data",this.onMessageCallback),e.bus.detach("negotiationneeded",this.onNegotiate),e.bus.detach("icecandidate",this.onIceCandidate),this.bus.emit("removepeer",this,e)}async onSyncPeerMessage(e){const n=e.message[0].toUInt(),s=JSON.parse(e.message[2].toString()),t=Array.isArray(s)?s.filter(i=>typeof i=="string"&&A(i)):[];if(t.filter(i=>this.findPeerById(i)==null).forEach(i=>{const o=new w(i,BigInt(0));this.addPeer(o)}),n===b){const i=Math.random()*2e3;await U(i);const o=this.peers.map(a=>a.userDeviceId).filter(a=>!t.includes(a));t.includes(this.userDeviceId)||o.push(this.userDeviceId),o.length>0&&await this.broadcastPeerList(o,!0)}}handleProtocolMessage(e){if(e.srcUserDeviceId===this.userDeviceId)return;const n=e.message[0].toUInt(),s=e.message[1].toBigUInt();let t=this.findPeerById(e.srcUserDeviceId);if(!t)t=new w(e.srcUserDeviceId,s),this.addPeer(t);else if(t.clk>=s)return;n===b||n===v?this.onSyncPeerMessage(e).catch(i=>console.error(i)):n===E?this.onProvideRTCOfferMessage(e).catch(i=>console.error(i)):n===_?this.onRTCIceCandidateMessage(e).catch(i=>console.error(i)):console.error("unknown message type #%d",n)}tick(){return this.clk++}buildProtocolMessage(e,n){return[h.fromUInt(e,!0),h.fromBigUInt(this.tick(),!0),h.fromString(JSON.stringify(n),!1)]}async stop(){const e=this.alterChan.close();typeof e!="undefined"&&await e;for(const n of this.peers)n.disconnect();for(let n=0;n<this.peers.length;n++)this.peers.pop();this.bus.emit("stopped",this),this.bus.detachAll()}async provideRTCOffer(e,n){this.send(e,this.buildProtocolMessage(E,n))}async onProvideRTCOfferMessage(e){const n=JSON.parse(e.message[2].toString());if(n&&typeof n=="object"&&n.type){const s=this.findPeerById(e.srcUserDeviceId),t=n;if(s&&(await s.connection.setRemoteDescription(t),t.type==="offer")){await s.connection.setLocalDescription();const i=s.connection.localDescription;i&&await this.provideRTCOffer(e.srcUserDeviceId,i)}}}async sendRTCIceCandidate(e,n){await this.send(e,this.buildProtocolMessage(_,n.toJSON()))}async onRTCIceCandidateMessage(e){const n=JSON.parse(e.message[2].toString());if(n&&typeof n=="object"&&n.candidate){const s=n,t=this.findPeerById(e.srcUserDeviceId);t&&t.connection.remoteDescription&&t.connection.addIceCandidate(s)}}}const N="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ.-:+=^!/*?&<>()[]{}@%$#".split(""),C=[0,68,0,84,83,82,72,0,75,76,70,65,0,63,62,69,0,1,2,3,4,5,6,7,8,9,64,0,73,66,74,71,81,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,77,0,78,67,0,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,79,0,80,0,0],G=r=>{if(r.length%4!==0)throw Error("data's length must be divisible by 4");const e=r.length;let n="",s=0,t=0;for(;s<e;){const i=r[s++];if(t=t*256+i,s%4===0){let o=52200625;for(;o>=1;){const a=Math.floor(t/o)%85;n+=N[a],o/=85}t=0}}return n},F=r=>{if(r.length%5!==0)throw Error("string's length must be divisible by 5");const e=new Uint8Array(r.length*4/5),n=r.length;let s=0,t=0,i=0;for(;t<n;){const o=r.charCodeAt(t++)-32;if(o<0||o>=C.length)return;if(i=i*85+C[o],t%5===0){let a=16777216;for(;a>=1;)e[s++]=i/a%256,a/=256;i=0}}return e};var I={encode:G,decode:F};class O{constructor(e,n,s,t){this.rtDbChannel=e,this.rtDbBroadcastChan=n,this.supabase=s,this.bus=new f,this.rtDbChannel.on("INSERT",void 0,i=>this.onRemoteMessage(i)),this.rtDbBroadcastChan.on("INSERT",void 0,i=>this.onRemoteMessage(i)),this.rtDbChannel.onClose(()=>this.onAnyChannelClose()),this.rtDbBroadcastChan.onClose(()=>this.onAnyChannelClose()),this.roomId=t,this.rtDbChannel.isJoined()||this.rtDbChannel.isJoining()||this.rtDbChannel.subscribe(),this.rtDbBroadcastChan.isJoined()||this.rtDbBroadcastChan.isJoining()||this.rtDbBroadcastChan.subscribe()}static ofRoom(e,n,s){const t=e.channel(`realtime:public:room_message_queue:dst_user_dev_id=eq.${s}`,{selfBroadcast:!0}),i=e.channel(`realtime:public:room_message_queue:dst_user_dev_id=eq.${p}`,{selfBroadcast:!1});return new O(t,i,e,n)}async send(e){const{error:n}=await this.supabase.from("room_message_queue").insert({room:e.roomId,dst_user_dev_id:e.dstUserDeviceId,src_user_dev_id:e.srcUserDeviceId,message:e.message.map(s=>{if(s.byteLength%4!==0){const t=4-s.byteLength%4;return I.encode(s.clone(t).buffer)}else return I.encode(s.buffer)})});if(n)throw n}onAnyChannelClose(){this.close(),this.rtDbBroadcastChan.isClosed()&&this.rtDbChannel.isClosed()&&this.bus.emit("close",this)}onRemoteMessage(e){if(e.errors)return;let n=!0;const s=e.record,t={roomId:s.room,dstUserDeviceId:s.dst_user_dev_id,srcUserDeviceId:s.src_user_dev_id,message:s.message.map(i=>{if(i.length%5!==0)return n=!1,h.zero(0);const o=I.decode(i);return o?new h(o):(n=!1,h.zero(0))})};n&&this.bus.emit("data",this,t)}close(){this.rtDbChannel.isClosed()||this.rtDbChannel.unsubscribe(),this.rtDbBroadcastChan.isClosed()||this.rtDbBroadcastChan.unsubscribe()}}export{h as F,M as P,V as R,O as S};
//# sourceMappingURL=index.79b5287a.js.map
